CREATE VIEW [V_EDAA_PRES].[FCT_DLY_STR_ITMSKU_TY_LY_FUEL_SLS]
AS
WITH CTE
AS
(
      SELECT
        CAST(b.DT_SK AS int) AS DT_SK,
        FORMAT(b.Lst_Yr_Fsc_Dt, 'yyyMMdd') AS LY_DT_SK,
        A.[ITM_SKU] AS ITM_SKU,
        A.[STR_ID] AS STR_ID,
        [SLS_AMT] AS [TY_SLS_AMT],
        0 AS [LY_SLS_AMT],
        [SLS_QTY] AS [TY_SLS_QTY],
        0 AS [LY_SLS_QTY],
        [DRCT_MGN_AMT] AS [TY_DRCT_MGN_AMT],
        0 AS [LY_DRCT_MGN_AMT],
		b.FSC_YR
      FROM [EDAA_DW].[FCT_DLY_STR_ITMSKU_SLS] (NOLOCK) AS a
      INNER JOIN edaa_dw.dim_dly_cal b
        ON a.DT_SK = b.DT_SK
      WHERE ITM_SKU IN (70882066971,71928383600,70882045793,71928338751,71928379052,71928395080,70882029984,70882035245,71928338752,71928338753,71928338754 )

	  UNION ALL


      SELECT
        CAST(b.DT_SK AS int) AS DT_SK,
        format(b.Lst_Yr_Fsc_Dt, 'yyyMMdd') AS LY_DT_SK,
        A.[ITM_SKU] AS ITM_SKU,
        A.[STR_ID] AS STR_ID,
        SLS_ADJ_AMT AS TY_SLS_ADJ_AMT,
        0 AS LY_SLS_ADJ_AMT,
        SLS_ADJ_QTY AS TY_SLS_ADJ_QTY,
        0 AS LY_SLS_ADJ_QTY,
        DRCT_MGN_ADJ_AMT AS TY_DRCT_MGN_ADJ_AMT,
        0 AS TY_DRCT_MGN_ADJ_AMT,
		b.FSC_YR
      FROM [EDAA_DW].[FCT_DLY_STR_ITMSKU_SLS_ADJ] (NOLOCK) AS a
      INNER JOIN edaa_dw.dim_dly_cal b
        ON a.DT_SK = b.DT_SK
      WHERE ITM_SKU IN (70882066971,71928383600,70882045793,71928338751,71928379052,71928395080,70882029984,70882035245,71928338752,71928338753,71928338754 )


	  UNION ALL

      SELECT
        CAST(b.DT_SK AS int) AS DT_SK,
        FORMAT(b.Lst_Yr_Fsc_Dt, 'yyyMMdd') AS LY_DT_SK,
        A.[ITM_SKU] AS ITM_SKU,
        A.[STR_ID] AS STR_ID,
        0 AS [TY_SLS_AMT],
        [SLS_AMT] AS [LY_SLS_AMT],
        0 AS [TY_SLS_QTY],
        [SLS_QTY] AS [LY_SLS_QTY],
        0 AS [TY_DRCT_MGN_AMT],
        [DRCT_MGN_AMT] AS [LY_DRCT_MGN_AMT],
		b.FSC_YR
      FROM [EDAA_DW].[FCT_DLY_STR_ITMSKU_SLS] (NOLOCK) AS a
      INNER JOIN edaa_dw.dim_dly_cal b
        ON a.DT_SK = FORMAT(b.Lst_Yr_Fsc_Dt, 'yyyMMdd')
        WHERE ITM_SKU IN (70882066971,71928383600,70882045793,71928338751,71928379052,71928395080,70882029984,70882035245,71928338752,71928338753,71928338754 )


	  UNION ALL

      SELECT
        CAST(b.DT_SK AS int) AS DT_SK,
        format(b.Lst_Yr_Fsc_Dt, 'yyyMMdd') AS LY_DT_SK,
        A.[ITM_SKU] AS ITM_SKU,
        A.[STR_ID] AS STR_ID,
        SLS_ADJ_AMT AS TY_SLS_ADJ_AMT,
        0 AS LY_SLS_ADJ_AMT,
        SLS_ADJ_QTY AS TY_SLS_ADJ_QTY,
        0 AS LY_SLS_ADJ_QTY,
        DRCT_MGN_ADJ_AMT AS TY_DRCT_MGN_ADJ_AMT,
        0 AS TY_DRCT_MGN_ADJ_AMT,
		b.FSC_YR
      FROM [EDAA_DW].[FCT_DLY_STR_ITMSKU_SLS_ADJ]  (NOLOCK) AS a
      INNER JOIN edaa_dw.dim_dly_cal b
        ON a.DT_SK = b.DT_SK
        WHERE ITM_SKU IN (70882066971,71928383600,70882045793,71928338751,71928379052,71928395080,70882029984,70882035245,71928338752,71928338753,71928338754 )

)

      SELECT
        [DT_SK],
        [LY_DT_SK],
        [ITM_SKU],
        [STR_ID],
        SUM([TY_SLS_AMT]) AS [TY_SLS_AMT],
        SUM([LY_SLS_AMT]) AS [LY_SLS_AMT],
        SUM([TY_SLS_QTY]) AS [TY_SLS_QTY],
        SUM([LY_SLS_QTY]) AS [LY_SLS_QTY],
        SUM([TY_DRCT_MGN_AMT]) AS [TY_DRCT_MGN_AMT],
        SUM([LY_DRCT_MGN_AMT]) AS [LY_DRCT_MGN_AMT],
        GETDATE() AS [UPDATEDTIMESTAMP]
      FROM  CTE
      WHERE FSC_YR >= YEAR(GETDATE())-2
      GROUP BY [DT_SK],
               [LY_DT_SK],
               [ITM_SKU],
               [STR_ID];
GO
