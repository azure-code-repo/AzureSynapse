CREATE VIEW [PRES].[V_FCT_WK_STRT_INV_P_SUB_CT_CALC] AS

SELECT  [GEO_HST_SKY]
      ,[GEO_SKY]
	   ,TM_SKY + 1 as TM_SKY
      ,[BYR_HST_SKY]
      ,[BYR_SKY]
      ,EMP.MJR_P_SUB_CT_ID as [P_SUB_CT_ID]
      ,[UT_ID]
      ,CAST(SUM([TG_INV_CST_AM]) as decimal(11, 2)) AS [TG_INV_CST_AM]
      ,CAST(SUM([TG_CLRN_INV_CST_AM]) as decimal(11, 2)) AS [TG_CLRN_INV_CST_AM]
      ,SUM([INV_CLRN_QTY]) AS [INV_CLRN_QTY]
      ,SUM([TG_INV_QT]) AS [TG_INV_QT]
      ,CAST(SUM([TG_INV_CST_AM_LY_CLDR]) as decimal(11, 2)) AS [TG_INV_CST_AM_LY_CLDR]
      ,CAST(SUM([TG_CLRN_INV_CST_AM_LY_CLDR]) as decimal(11, 2)) AS [TG_CLRN_INV_CST_AM_LY_CLDR]
      ,SUM([INV_CLRN_QTY_LY_CLDR]) AS [INV_CLRN_QTY_LY_CLDR]
      ,SUM([TG_INV_QTY_LY_CLDR]) AS [TG_INV_QTY_LY_CLDR]
      ,CAST(SUM([TG_INV_CST_AM_LY_FSC]) as decimal(11, 2)) AS [TG_INV_CST_AM_LY_FSC]
      ,CAST(SUM([TG_CLRN_INV_CST_AM_LY_FSC]) as decimal(11, 2)) AS [TG_CLRN_INV_CST_AM_LY_FSC]
      ,SUM([INV_CLRN_QTY_LY_FSC]) AS [INV_CLRN_QTY_LY_FSC]
      ,SUM([TG_INV_QTY_LY_FSC]) AS [TG_INV_QTY_LY_FSC]
      ,CAST(SUM([TG_INV_CST_AM_LY_HLDY]) as decimal(11, 2)) AS [TG_INV_CST_AM_LY_HLDY]
      ,CAST(SUM([TG_CLRN_INV_CST_AM_LY_HLDY]) as decimal(11, 2)) AS  [TG_CLRN_INV_CST_AM_LY_HLDY]
      ,SUM([INV_CLRN_QTY_LY_HLDY]) AS [INV_CLRN_QTY_LY_HLDY]
      ,SUM([TG_INV_QTY_LY_HLDY]) AS [TG_INV_QTY_LY_HLDY]
      ,CAST(SUM([TG_INV_CST_AM_DIFF_TY_VS_LY_CLDR]) as decimal(11, 2)) AS [TG_INV_CST_AM_DIFF_TY_VS_LY_CLDR]
      ,CAST(SUM([TG_CLRN_INV_CST_AM_DIFF_TY_VS_LY_CLDR]) as decimal(11, 2)) AS [TG_CLRN_INV_CST_AM_DIFF_TY_VS_LY_CLDR]
      ,SUM([INV_CLRN_QTY_DIFF_TY_VS_LY_CLDR]) AS [INV_CLRN_QTY_DIFF_TY_VS_LY_CLDR]
      ,SUM([TG_INV_QTY_DIFF_TY_VS_LY_CLDR]) AS [TG_INV_QTY_DIFF_TY_VS_LY_CLDR]
      ,CAST(SUM([TG_INV_CST_AM_DIFF_TY_VS_LY_FSC]) as decimal(11, 2)) AS [TG_INV_CST_AM_DIFF_TY_VS_LY_FSC]
      ,CAST(SUM([TG_CLRN_INV_CST_AM_DIFF_TY_VS_LY_FSC]) as decimal(11, 2)) AS [TG_CLRN_INV_CST_AM_DIFF_TY_VS_LY_FSC]
      ,SUM([INV_CLRN_QTY_DIFF_TY_VS_LY_FSC]) AS [INV_CLRN_QTY_DIFF_TY_VS_LY_FSC]
      ,SUM([TG_INV_QTY_DIFF_TY_VS_LY_FSC]) AS [TG_INV_QTY_DIFF_TY_VS_LY_FSC]
      ,CAST(SUM([TG_INV_CST_AM_DIFF_TY_VS_LY_HLDY]) as decimal(11, 2)) AS [TG_INV_CST_AM_DIFF_TY_VS_LY_HLDY]
      ,CAST(SUM([TG_CLRN_INV_CST_AM_DIFF_TY_VS_LY_HLDY]) as decimal(11, 2)) AS [TG_CLRN_INV_CST_AM_DIFF_TY_VS_LY_HLDY]
      ,SUM([INV_CLRN_QTY_DIFF_TY_VS_LY_HLDY]) AS [INV_CLRN_QTY_DIFF_TY_VS_LY_HLDY]
      ,SUM([TG_INV_QTY_DIFF_TY_VS_LY_HLDY]) AS [TG_INV_QTY_DIFF_TY_VS_LY_HLDY]
  FROM [PRES].[FCT_WK_STRT_INV_P_SUB_CT_CALC] S
  INNER JOIN [PRES].[DIM_P_L3] P
  ON P.[P_HST_SKY] = S.[P_HST_SKY]
   INNER JOIN [dm_edw].[BYR_EMP_PKY_MPRS_CURRPREV_INF] emp
  ON P.FNC_PKY_ID = emp.PKY_ID and emp.MPRS_CT_ID = P.FNC_MPRS_CT_ID
  GROUP BY
  [GEO_HST_SKY]
      ,[GEO_SKY]
      ,[TM_SKY]
	 ,EMP.[MJR_P_SUB_CT_ID]
	  ,[P_SUB_CT_ID]
      ,[BYR_HST_SKY]
      ,[BYR_SKY]
      ,[UT_ID]

union all
SELECT  [GEO_HST_SKY]
      ,[GEO_SKY]
	   ,TM_SKY + 1 as TM_SKY
      ,[BYR_HST_SKY]
      ,[BYR_SKY]
      ,'n/a' as [P_SUB_CT_ID]
      ,[UT_ID]
      ,CAST(SUM([TG_INV_CST_AM]) as decimal(11, 2)) AS [TG_INV_CST_AM]
      ,CAST(SUM([TG_CLRN_INV_CST_AM]) as decimal(11, 2)) AS [TG_CLRN_INV_CST_AM]
      ,SUM([INV_CLRN_QTY]) AS [INV_CLRN_QTY]
      ,SUM([TG_INV_QT]) AS [TG_INV_QT]
      ,CAST(SUM([TG_INV_CST_AM_LY_CLDR]) as decimal(11, 2)) AS [TG_INV_CST_AM_LY_CLDR]
      ,CAST(SUM([TG_CLRN_INV_CST_AM_LY_CLDR]) as decimal(11, 2)) AS [TG_CLRN_INV_CST_AM_LY_CLDR]
      ,SUM([INV_CLRN_QTY_LY_CLDR]) AS [INV_CLRN_QTY_LY_CLDR]
      ,SUM([TG_INV_QTY_LY_CLDR]) AS [TG_INV_QTY_LY_CLDR]
      ,CAST(SUM([TG_INV_CST_AM_LY_FSC]) as decimal(11, 2)) AS [TG_INV_CST_AM_LY_FSC]
      ,CAST(SUM([TG_CLRN_INV_CST_AM_LY_FSC]) as decimal(11, 2)) AS [TG_CLRN_INV_CST_AM_LY_FSC]
      ,SUM([INV_CLRN_QTY_LY_FSC]) AS [INV_CLRN_QTY_LY_FSC]
      ,SUM([TG_INV_QTY_LY_FSC]) AS [TG_INV_QTY_LY_FSC]
      ,CAST(SUM([TG_INV_CST_AM_LY_HLDY]) as decimal(11, 2)) AS [TG_INV_CST_AM_LY_HLDY]
      ,CAST(SUM([TG_CLRN_INV_CST_AM_LY_HLDY]) as decimal(11, 2)) AS  [TG_CLRN_INV_CST_AM_LY_HLDY]
      ,SUM([INV_CLRN_QTY_LY_HLDY]) AS [INV_CLRN_QTY_LY_HLDY]
      ,SUM([TG_INV_QTY_LY_HLDY]) AS [TG_INV_QTY_LY_HLDY]
      ,CAST(SUM([TG_INV_CST_AM_DIFF_TY_VS_LY_CLDR]) as decimal(11, 2)) AS [TG_INV_CST_AM_DIFF_TY_VS_LY_CLDR]
      ,CAST(SUM([TG_CLRN_INV_CST_AM_DIFF_TY_VS_LY_CLDR]) as decimal(11, 2)) AS [TG_CLRN_INV_CST_AM_DIFF_TY_VS_LY_CLDR]
      ,SUM([INV_CLRN_QTY_DIFF_TY_VS_LY_CLDR]) AS [INV_CLRN_QTY_DIFF_TY_VS_LY_CLDR]
      ,SUM([TG_INV_QTY_DIFF_TY_VS_LY_CLDR]) AS [TG_INV_QTY_DIFF_TY_VS_LY_CLDR]
      ,CAST(SUM([TG_INV_CST_AM_DIFF_TY_VS_LY_FSC]) as decimal(11, 2)) AS [TG_INV_CST_AM_DIFF_TY_VS_LY_FSC]
      ,CAST(SUM([TG_CLRN_INV_CST_AM_DIFF_TY_VS_LY_FSC]) as decimal(11, 2)) AS [TG_CLRN_INV_CST_AM_DIFF_TY_VS_LY_FSC]
      ,SUM([INV_CLRN_QTY_DIFF_TY_VS_LY_FSC]) AS [INV_CLRN_QTY_DIFF_TY_VS_LY_FSC]
      ,SUM([TG_INV_QTY_DIFF_TY_VS_LY_FSC]) AS [TG_INV_QTY_DIFF_TY_VS_LY_FSC]
      ,CAST(SUM([TG_INV_CST_AM_DIFF_TY_VS_LY_HLDY]) as decimal(11, 2)) AS [TG_INV_CST_AM_DIFF_TY_VS_LY_HLDY]
      ,CAST(SUM([TG_CLRN_INV_CST_AM_DIFF_TY_VS_LY_HLDY]) as decimal(11, 2)) AS [TG_CLRN_INV_CST_AM_DIFF_TY_VS_LY_HLDY]
      ,SUM([INV_CLRN_QTY_DIFF_TY_VS_LY_HLDY]) AS [INV_CLRN_QTY_DIFF_TY_VS_LY_HLDY]
      ,SUM([TG_INV_QTY_DIFF_TY_VS_LY_HLDY]) AS [TG_INV_QTY_DIFF_TY_VS_LY_HLDY]
  FROM [PRES].[FCT_WK_STRT_INV_P_SUB_CT_CALC] S
  INNER JOIN [PRES].[DIM_P_L3] P
  ON P.[P_HST_SKY] = S.[P_HST_SKY]
  where s.[P_HST_SKY]=-1
  GROUP BY
  [GEO_HST_SKY]
      ,[GEO_SKY]
      ,[TM_SKY]
	 ,P.[P_SUB_CT_ID]
	  ,[P_SUB_CT_ID]
      ,[BYR_HST_SKY]
      ,[BYR_SKY]
      ,[UT_ID]
